@model User
@{
    ViewData["Title"] = "Register";
}

<br />
<br />
<br />
<br />
<div class="container mt-5">
    <div class="row justify-content-center align-items-center shadow-lg rounded-4 overflow-hidden">
        <!-- Left side: Image -->
        <div class="col-md-5 d-none d-md-block p-0">
            <img src="~/img/market.png" class="w-100" style="max-height: 500px; object-fit: cover;" alt="Market Image" />
        </div>

        <!-- Right side: Form -->
        <div class="col-md-7 p-5 bg-white">
            <h2 class="text-primary mb-4 text-center">Create Your Account</h2>

            <form method="post" asp-action="Register" enctype="multipart/form-data">
                <div asp-validation-summary="All" class="text-danger"></div>

                <div class="mb-3">
                    <label asp-for="Name" class="form-label">Full Name</label>
                    <input asp-for="Name" class="form-control" required />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Email" class="form-label">Email Address</label>
                    <input asp-for="Email" type="email" class="form-control" required />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Phone" class="form-label">Phone Number</label>
                    <input asp-for="Phone" class="form-control" />
                    <span asp-validation-for="Phone" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Address" class="form-label">Address</label>
                    <input id="addressInput" name="Address" class="form-control" placeholder="Start typing city, village, country..." autocomplete="off" />
                    <ul id="autocomplete-list" class="list-group position-absolute w-100" style="z-index: 999; list-style: none; max-height: 150px; overflow-y: auto; display: none; background: white; border: 1px solid #ccc;"></ul>
                    <span asp-validation-for="Address" class="text-danger"></span>
                </div>


                <div class="mb-3">
                    <label asp-for="PostalCode" class="form-label">Postal Code</label>
                    <input asp-for="PostalCode" class="form-control" />
                    <span asp-validation-for="PostalCode" class="text-danger"></span>
                </div>

                <div class="mb-3 position-relative">
                    <label asp-for="Password" class="form-label">Password</label>
                    <input asp-for="Password" type="password" class="form-control pe-5" id="passwordInput" required />
                    <span asp-validation-for="Password" class="text-danger"></span>
                    <br />
                    <span class="position-absolute top-50 end-0 translate-middle-y pe-3" style="cursor: pointer;" id="togglePassword">
                        <i class="bi bi-eye" id="togglePasswordIcon"></i>
                    </span>
                </div>
                <div class="mb-3 position-relative">
                    <label asp-for="ConfirmPassword" class="form-label">Confirm Password</label>
                    <input asp-for="ConfirmPassword" type="password" class="form-control pe-5" id="confirmPasswordInput" required />
                    <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                    <br />
                    <span class="position-absolute top-50 end-0 translate-middle-y pe-3" style="cursor: pointer;" id="toggleConfirmPassword">
                        <i class="bi bi-eye" id="toggleConfirmPasswordIcon"></i>
                    </span>
                </div>


                <div class="mb-3">
                    <label class="form-label">Profile Picture (Optional)</label>
                    <input type="file" name="profileImage" class="form-control" id="profileImageInput" accept="image/*" />
                    <img id="profileImagePreview" src="#" alt="Profile Picture Preview" class="img-thumbnail mt-2" style="display:none; max-width:150px; max-height:150px;" />
                </div>

                <button type="submit" class="btn btn-primary w-100">Register</button>
                <div class="mt-3 text-center">
                    <span>Already a customer? <a asp-action="Login" asp-controller="UserAccount" class="text-decoration-none">Login here</a></span>
                </div>
            </form>

            <div class="mt-3">
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function () {
            const passwordInput = document.getElementById('passwordInput');
            const icon = document.getElementById('togglePasswordIcon');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });

        // Toggle confirm password visibility
        document.getElementById('toggleConfirmPassword').addEventListener('click', function () {
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            const icon = document.getElementById('toggleConfirmPasswordIcon');
            if (confirmPasswordInput.type === 'password') {
                confirmPasswordInput.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                confirmPasswordInput.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });


        // Autofill address using geolocation API
        document.getElementById('addressInput').addEventListener('focus', function () {
            fetch('https://ipapi.co/json')
                .then(res => res.json())
                .then(data => {
                    this.value = `${data.city}, ${data.region}, ${data.country_name}`;
                });
        });

        // Profile image live preview
        document.getElementById('profileImageInput').addEventListener('change', function (event) {
            const preview = document.getElementById('profileImagePreview');
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                preview.src = '#';
                preview.style.display = 'none';
            }
        });

              // API
       
                  const addressInput = document.getElementById('addressInput');
        const autocompleteList = document.getElementById('autocomplete-list');

        addressInput.addEventListener('keyup', function () {
            const query = this.value.trim();

            if (query.length < 3) {
                autocompleteList.style.display = "none";
                return;
            }

            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    autocompleteList.innerHTML = '';

                    if (data.length === 0) {
                        autocompleteList.style.display = "none";
                        return;
                    }

                    data.forEach(location => {
                        const item = document.createElement('li');
                        item.textContent = location.display_name;
                        item.className = 'list-group-item list-group-item-action';
                        item.style.cursor = 'pointer';

                        item.onclick = function () {
                            addressInput.value = location.display_name;
                            autocompleteList.innerHTML = '';
                            autocompleteList.style.display = "none";
                        };

                        autocompleteList.appendChild(item);
                    });

                    autocompleteList.style.display = 'block';
                })
                .catch(err => {
                    console.error('Autocomplete error:', err);
                    autocompleteList.style.display = "none";
                });
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function (e) {
            if (!autocompleteList.contains(e.target) && e.target !== addressInput) {
                autocompleteList.innerHTML = '';
                autocompleteList.style.display = "none";
            }
        });
    </script>
}
